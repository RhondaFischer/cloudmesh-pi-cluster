# Setting up a Pi Kubernetes Cluster

Source: <https://blog.alexellis.io/test-drive-k3s-on-raspberry-pi/>

Use cloudmesh.common.Shell wherever possible. Onet use pipes and >> <<
develop alternative python programs as they may be easier to do than shell scripts
 
 
## Related information

This may be the way to go just that we do the install from the master instead of a laptop?

* <https://github.com/alexellis/k3sup#-micro-tutorial-for-raspberry-pi-2-3-or-4->

We can wrap the join commands in our parallel ssh command to make things faster i hope

* <https://github.com/OmegaSquad82/ansible-k3sup>


## Enable Containers

if "cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory" not in /boot/cmdline.txt
   cat  cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory >>  /boot/cmdline.txt
   

see cloudmesh.k3.k3.enable_containers():

## Setup
### Master
First install Kubernetes (K3S) on the master: 
```
curl -sfL https://get.k3s.io | sh -
```

You can check the status of K3S by using: 
```
sudo systemctl status k3s
```

### Worker (Command Line Implementation)
(Note: 'cms pi' command not implemented yet, currently just command line implementation for each worker)

Steps: 
1. You must first set up your workers to connect to the internet through your master. This is done by using the command ```cms burn```. You can find the documentation here to set it up 
* https://github.com/cloudmesh/cloudmesh-pi-cluster/tree/master/cloudmesh/bridge

2. You need to grab the join-token key generated by your master using the command: 
```
sudo cat /var/lib/rancher/k3s/server/node-token
```

3. ssh to your worker node 
```
ssh [WORKER-IP]
```

4. On your worker, run the following command filling in the necessary parameters:
```
curl -sfL http://get.k3s.io | K3S_URL=https://[MASTER IP]:6443  \
K3S_TOKEN=[JOIN-TOKEN FROM STEP 1] sh -
```
CURRENT BUG: When running the above command, it will set a password for your Raspberry Pi (which does not display in the command output either) 

### View Cluster
You can view your cluster setup with master and work status with the command:
```
sudo kubectl get node

NAME       STATUS   ROLES    AGE    VERSION
purple     Ready    master   2d1h   v1.17.4+k3s1
purple01   Ready    <none>   22m    v1.17.4+k3s1

```
